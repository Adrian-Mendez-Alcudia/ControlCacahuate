<div class="pos-container">
  <!-- Header Minimalista -->
  <header class="header">
    <div class="brand">
      <span class="logo">ðŸ¥œ</span>
      <h1>Control Cacahuate</h1>
    </div>
    <p class="subtitle">Punto de Venta</p>
  </header>

  <!-- Notificaciones Flotantes -->
  @if (mensaje) {
  <div class="toast-notification" [class.error]="mensajeError">
    {{ mensaje }}
  </div>
  }

  <!-- Grid de Productos -->
  <div class="grid-productos">
    @if (saboresConInventario$ | async; as sabores) { @if (sabores.length === 0)
    {
    <div class="empty-state">
      <div class="icon">ðŸ“¦</div>
      <h3>Sin productos</h3>
      <p>Agrega sabores en configuraciÃ³n</p>
    </div>
    } @else { @for (sabor of sabores; track sabor.id) {
    <!-- Tarjeta de Producto -->
    <div
      class="producto-card"
      [class.sin-stock]="sabor.cantidad <= 0"
      [style.--card-color]="sabor.color"
      (click)="agregarAlCarrito(sabor)"
    >
      <!-- Badge Cantidad (si hay en carrito) -->
      @if (getCantidadEnCarrito(sabor.id) > 0) {
      <div class="badge-cantidad">
        {{ getCantidadEnCarrito(sabor.id) }}
      </div>
      <!-- BotÃ³n Restar RÃ¡pido (evita abrir el modal solo para restar 1) -->
      <button
        class="btn-restar-rapido"
        (click)="$event.stopPropagation(); restarDelCarrito(sabor)"
      >
        -
      </button>
      }

      <div class="card-content">
        <span class="emoji">{{ sabor.emoji }}</span>
        <span class="nombre">{{ sabor.nombre }}</span>

        <div class="stock-pill" [class.agotado]="sabor.cantidad <= 0">
          {{ sabor.cantidad > 0 ? sabor.cantidad + " disp." : "AGOTADO" }}
        </div>
      </div>
    </div>
    } } } @else {
    <!-- Skeletons de carga -->
    @for (i of [1,2,3,4,5,6]; track i) {
    <div class="skeleton-card"></div>
    } }
  </div>

  <!-- Resumen Footer (solo si no hay carrito activo) -->
  @if (carritoService.cantidadItems() === 0) {
  <div class="resumen-footer">
    <div class="stat">
      <span class="label">Ventas Hoy</span>
      <span class="valor cash">{{ formatearMoneda(efectivoHoy) }}</span>
    </div>
    <div class="divider"></div>
    <div class="stat">
      <span class="label">Fiado Hoy</span>
      <span class="valor credit">{{ formatearMoneda(fiadoHoy) }}</span>
    </div>
  </div>
  }
</div>

<!-- Barra de AcciÃ³n Flotante (Carrito Activo) -->
@if (carritoService.cantidadItems() > 0) {
<div class="floating-action-bar">
  <div class="cart-info" (click)="abrirModalCobrar()">
    <div class="count">{{ carritoService.cantidadItems() }} items</div>
    <div class="total">{{ formatearMoneda(carritoService.total()) }}</div>
  </div>

  <button class="btn-cobrar" (click)="abrirModalCobrar()">
    Cobrar <span>âž”</span>
  </button>
</div>
}

<!-- Modal de Cobro (Bottom Sheet) -->
@if (modalCobroVisible) {
<div class="modal-backdrop" (click)="cerrarModal()">
  <div class="bottom-sheet" (click)="$event.stopPropagation()">
    <div class="sheet-handle"></div>

    <div class="sheet-header">
      <h2>ðŸ›’ Tu Pedido</h2>
      <button
        class="btn-clear"
        (click)="carritoService.limpiarCarrito(); cerrarModal()"
      >
        Vaciar
      </button>
    </div>

    <div class="cart-items-scroll">
      @for (item of carritoService.carrito(); track item.sabor.id) {
      <div class="cart-row">
        <div class="row-info">
          <span class="emoji">{{ item.sabor.emoji }}</span>
          <span class="name">{{ item.sabor.nombre }}</span>
        </div>

        <div class="row-controls">
          <button (click)="restarDelCarrito(item.sabor)">-</button>
          <span class="qty">{{ item.cantidad }}</span>
          <button (click)="agregarAlCarrito(item.sabor)">+</button>
        </div>

        <div class="row-price">
          {{ formatearMoneda(item.subtotal) }}
        </div>
      </div>
      }
    </div>

    <div class="sheet-total">
      <span>Total a Pagar</span>
      <span class="amount">{{ formatearMoneda(carritoService.total()) }}</span>
    </div>

    <div class="payment-actions">
      <button
        class="btn-pay cash"
        (click)="venderEfectivo()"
        [disabled]="procesando"
      >
        <span class="icon">ðŸ’µ</span> Cobrar Efectivo
      </button>

      <div class="credit-section">
        <p>O fiar a:</p>
        <div class="clients-scroll">
          <button class="btn-chip add" (click)="abrirModalNuevoCliente()">
            + Nuevo
          </button>
          @if (clientes$ | async; as clientes) { @for (cliente of clientes;
          track cliente.id) {
          <button
            class="btn-chip"
            (click)="venderFiado(cliente)"
            [disabled]="procesando"
          >
            {{ cliente.alias }}
          </button>
          } }
        </div>
      </div>
    </div>
  </div>
</div>
}

<!-- Modal RÃ¡pido Nuevo Cliente -->
@if (modalNuevoCliente) {
<div class="modal-backdrop center" (click)="cerrarModalNuevoCliente()">
  <div class="dialog-box" (click)="$event.stopPropagation()">
    <h3>Nuevo Cliente</h3>
    <input
      id="inputNuevoCliente"
      type="text"
      [(ngModel)]="nuevoClienteAlias"
      placeholder="Nombre o Alias"
      (keyup.enter)="crearClienteYFiar()"
    />
    <div class="dialog-actions">
      <button class="btn-secondary" (click)="cerrarModalNuevoCliente()">
        Cancelar
      </button>
      <button
        class="btn-primary"
        (click)="crearClienteYFiar()"
        [disabled]="procesando"
      >
        Crear y Fiar
      </button>
    </div>
  </div>
</div>
}
