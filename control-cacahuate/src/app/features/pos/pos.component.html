<div class="pos-container">
  <!-- Header -->
  <header class="header">
    <h1>ğŸ¥œ Control Cacahuate</h1>
    <p class="subtitle">Toca los sabores para agregar al carrito</p>
  </header>

  <!-- Mensaje de feedback -->
  @if (mensaje) {
  <div class="mensaje" [class.error]="mensajeError">{{ mensaje }}</div>
  }

  <!-- Grid de sabores -->
  <div class="sabores-grid">
    @if (saboresConInventario$ | async; as sabores) { @if (sabores.length === 0)
    {
    <div class="empty-state">
      <span class="emoji">ğŸ¥œ</span>
      <p>No hay sabores configurados</p>
      <p class="hint">Ve a <strong>Config</strong> para agregar tus sabores</p>
    </div>
    } @else { @for (sabor of sabores; track sabor.id) {
    <div
      class="sabor-btn"
      [class.sin-stock]="sabor.cantidad <= 0"
      [style.--sabor-color]="sabor.color"
      (click)="agregarAlCarrito(sabor)"
      role="button"
      tabindex="0"
    >
      <!-- Badge de cantidad en carrito -->
      @if (carritoService.obtenerCantidad(sabor.id) > 0) {
      <span class="badge-cantidad">{{
        carritoService.obtenerCantidad(sabor.id)
      }}</span>

      <!-- BotÃ³n para restar directo en la tarjeta -->
      <button
        class="btn-menos-card"
        (click)="$event.stopPropagation(); restarDelCarrito(sabor)"
      >
        -
      </button>
      }

      <span class="emoji">{{ sabor.emoji }}</span>
      <span class="nombre">{{ sabor.nombre }}</span>
      <span class="stock" [class.agotado]="sabor.cantidad <= 0">
        @if (sabor.cantidad > 0) {
        {{ sabor.cantidad }} disponibles } @else { Sin stock }
      </span>
      <span class="precio">{{ formatearMoneda(precioVenta) }}</span>
    </div>
    } } } @else {
    <!-- AQUÃ ES DONDE USAMOS EL SKELETON (Esto es lo que faltaba) -->
    @for (i of [1,2,3,4,5,6]; track i) {
    <div
      class="sabor-btn"
      style="border-color: #3d3d5c; background: #2d2d44; cursor: default"
    >
      <!-- Emoji skeleton -->
      <app-skeleton width="40px" height="40px" shape="circle"></app-skeleton>
      <!-- Nombre skeleton -->
      <app-skeleton width="70%" height="16px"></app-skeleton>
      <!-- Stock badge skeleton -->
      <app-skeleton
        width="50%"
        height="20px"
        borderRadius="12px"
      ></app-skeleton>
      <!-- Precio skeleton -->
      <app-skeleton width="40%" height="24px"></app-skeleton>
    </div>
    } }
  </div>

  <!-- Resumen del dÃ­a (Solo si carrito vacÃ­o) -->
  @if (carritoService.cantidadItems() === 0) {
  <div class="resumen-dia">
    <h3>Resumen del dÃ­a</h3>
    <div class="resumen-row">
      <span>ğŸ’µ Efectivo:</span>
      <span class="efectivo">{{ formatearMoneda(efectivoHoy) }}</span>
    </div>
    <div class="resumen-row">
      <span>ğŸ“ Fiado hoy:</span>
      <span class="fiado">{{ formatearMoneda(fiadoHoy) }}</span>
    </div>
  </div>
  }
</div>

<!-- Barra de Cobro Flotante -->
@if (carritoService.cantidadItems() > 0) {
<div class="barra-cobro">
  <button class="btn-vaciar-rapido" (click)="carritoService.limpiarCarrito()">
    ğŸ—‘ï¸
  </button>

  <div class="info-cobro">
    <span class="items-count"
      >{{ carritoService.cantidadItems() }} artÃ­culos</span
    >
    <span class="total">{{ formatearMoneda(carritoService.total()) }}</span>
  </div>

  <button class="btn-ver-cobrar" (click)="abrirModalCobrar()">Cobrar</button>
</div>
}

<!-- Modal de Cobro (Carrito) -->
@if (modalCobroVisible) {
<div class="modal-overlay" (click)="cerrarModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <h2>ğŸ›’ Tu Pedido</h2>

    <!-- Lista de items en carrito -->
    <div class="carrito-lista">
      @for (item of carritoService.carrito(); track item.sabor.id) {
      <div class="carrito-item">
        <div class="info-item">
          <span class="emoji">{{ item.sabor.emoji }}</span>
          <span class="nombre">{{ item.sabor.nombre }}</span>
        </div>
        <div class="controles-cantidad">
          <button
            class="btn-qty"
            (click)="carritoService.restarItem(item.sabor.id)"
          >
            -
          </button>
          <span class="qty">{{ item.cantidad }}</span>
          <button class="btn-qty" (click)="agregarAlCarrito(item.sabor)">
            +
          </button>
        </div>
        <div class="subtotal">
          {{ formatearMoneda(item.cantidad * item.precioVenta) }}
        </div>
      </div>
      }
    </div>

    <div class="total-final">
      <span>Total a Pagar:</span>
      <span class="monto">{{ formatearMoneda(carritoService.total()) }}</span>
    </div>

    <h3 class="metodo-pago-titulo">Selecciona mÃ©todo de pago:</h3>

    <!-- BotÃ³n efectivo -->
    <button
      class="btn-efectivo"
      (click)="venderEfectivo()"
      [disabled]="procesando"
    >
      ğŸ’µ Efectivo
    </button>

    <!-- SecciÃ³n fiado -->
    <div class="seccion-fiado">
      <p class="fiado-label">ğŸ“ Fiado - Selecciona cliente:</p>

      @if (clientes$ | async; as clientes) {
      <div class="clientes-lista">
        @for (cliente of clientes; track cliente.id) {
        <button
          class="cliente-btn"
          (click)="venderFiado(cliente)"
          [disabled]="procesando"
        >
          <span>{{ cliente.alias }}</span>
          <span class="deuda" [class.tiene-deuda]="cliente.saldoPendiente > 0">
            {{ formatearMoneda(cliente.saldoPendiente) }}
          </span>
        </button>
        }
      </div>
      }

      <button class="btn-nuevo-cliente" (click)="abrirModalNuevoCliente()">
        + Nuevo cliente
      </button>
    </div>

    <button
      class="btn-cancelar"
      (click)="carritoService.limpiarCarrito(); cerrarModal()"
    >
      ğŸ—‘ï¸ Vaciar Carrito y Cancelar
    </button>
    <button class="btn-cancelar-simple" (click)="cerrarModal()">
      Seguir comprando
    </button>
  </div>
</div>
}

<!-- Modal nuevo cliente -->
@if (modalNuevoCliente) {
<div class="modal-overlay" (click)="cerrarModalNuevoCliente()">
  <div class="modal" (click)="$event.stopPropagation()">
    <h2>ğŸ‘¤ Nuevo Cliente</h2>

    <div class="form-group">
      <label>Nombre o alias</label>
      <input
        type="text"
        [(ngModel)]="nuevoClienteAlias"
        placeholder="Ej: Juan MecÃ¡nico"
        (keyup.enter)="crearClienteYFiar()"
      />
    </div>

    <button
      class="btn-efectivo"
      (click)="crearClienteYFiar()"
      [disabled]="!nuevoClienteAlias.trim() || procesando"
    >
      âœ“ Crear y Fiar Pedido
    </button>

    <button class="btn-cancelar" (click)="cerrarModalNuevoCliente()">
      Cancelar
    </button>
  </div>
</div>
}
