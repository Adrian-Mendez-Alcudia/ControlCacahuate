<div class="produccion-container">
  <header class="header">
    <h1>üì¶ Centro de Producci√≥n</h1>
    <p class="subtitle">Registra cocinadas y gestiona stock</p>
  </header>

  <!-- Mensaje Feedback -->
  @if (mensaje) {
  <div class="mensaje" [class.error]="mensajeError">{{ mensaje }}</div>
  }

  <!-- Bot√≥n de Acci√≥n Principal -->
  <button class="btn-nuevo-lote" (click)="abrirModal()">
    <span class="icon">üç≥</span> Registrar Lote (Cocinada)
  </button>

  <!-- Secci√≥n de Inventario -->
  <section class="seccion">
    <h2>üìä Stock y Costos</h2>

    @if (saboresConInventario$ | async; as sabores) { @if (sabores.length === 0)
    {
    <div class="empty-state">
      <p>No hay sabores configurados</p>
      <p class="hint">Ve a Configuraci√≥n para agregar sabores</p>
    </div>
    } @else {
    <div class="inventario-lista">
      @for (sabor of sabores; track sabor.id) {
      <div class="inventario-item" [style.--sabor-color]="sabor.color">
        <div class="sabor-info">
          <span class="emoji">{{ sabor.emoji }}</span>
          <div class="textos">
            <span class="nombre">{{ sabor.nombre }} </span>
            <span class="stock-label"> Stock Actual </span>
          </div>
        </div>
        <div class="sabor-stats">
          <div class="cantidad" [class.bajo-stock]="sabor.cantidad < 10">
            {{ sabor.cantidad }} bolsas
          </div>
          @if (sabor.costoPromedio > 0) {
          <div class="costo">
            Costo: {{ formatearMoneda(sabor.costoPromedio) }}
          </div>
          } @else {
          <div class="costo sin-costo">Sin costo registrado</div>
          }
        </div>
      </div>
      }
    </div>
    } } @else {
    <div class="loading">Cargando inventario...</div>
    }
  </section>

  <!-- Historial de Lotes -->
  <section class="seccion">
    <h2>üìù √öltimas Cocinadas</h2>

    @if (lotes$ | async; as lotes) { @if (sabores$ | async; as sabores) { @if
    (lotes.length === 0) {
    <div class="empty-state">
      <p>A√∫n no has registrado ning√∫n lote.</p>
    </div>
    } @else {
    <div class="lotes-lista">
      @for (lote of lotes.slice(0, 15); track lote.id) {
      <div
        class="lote-item"
        [style.--sabor-color]="getSaborColor(lote.saborId, sabores)"
      >
        <div class="lote-header">
          <span class="lote-sabor">
            {{ getSaborEmoji(lote.saborId, sabores) }}
            {{ getSaborNombre(lote.saborId, sabores) }}
          </span>
          <span class="lote-fecha">
            {{ lote.fechaProduccion.toDate() | date : "dd/MM HH:mm" }}
          </span>
        </div>
        <div class="lote-detalles">
          <div class="detalle-bloque">
            <span class="label">Producci√≥n </span>
            <span class="valor">{{ lote.bolsasResultantes }} bolsas</span>
          </div>
          <div class="detalle-bloque">
            <span class="label">Inversi√≥n </span>
            <span class="valor">{{ formatearMoneda(lote.costoKilo) }}</span>
          </div>
          <div class="detalle-bloque highlight">
            <span class="label">Costo Unitario </span>
            <span class="valor">{{ formatearMoneda(lote.costoUnitario) }}</span>
          </div>
        </div>
        @if (lote.notas) {
        <div class="lote-notas">
          <span class="icon">üìù</span> {{ lote.notas }}
        </div>
        }
      </div>
      }
    </div>
    } } } @else {
    <div class="loading">Cargando historial...</div>
    }
  </section>
</div>

<!-- Modal Nuevo Lote -->
@if (modalVisible) {
<div class="modal-overlay" (click)="cerrarModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <h2>üç≥ Registrar Lote</h2>
    <p class="modal-subtitle">Ingresa los datos de la cocinada de hoy</p>

    <!-- Selector de sabor -->
    <div class="form-group">
      <label>¬øQu√© sabor cocinaste?</label>
      <select [(ngModel)]="nuevoLote.saborId" class="select-lg">
        <option value="" disabled selected>Selecciona un sabor...</option>
        @if (sabores$ | async; as sabores) { @for (sabor of sabores; track
        sabor.id) {
        <option [value]="sabor.id">{{ sabor.emoji }} {{ sabor.nombre }}</option>
        } }
      </select>
    </div>

    <div class="grid-2-col">
      <!-- Costo Insumos -->
      <div class="form-group">
        <label>Costo Insumos (Total)</label>
        <div class="input-prefix">
          <span class="prefix">$</span>
          <input
            type="number"
            [(ngModel)]="nuevoLote.costoKilo"
            (ngModelChange)="calcularCostos()"
            placeholder="0.00"
            min="1"
          />
        </div>
        <span class="hint">Cacahuate + Aceite + Gas...</span>
      </div>

      <!-- Bolsas Resultantes -->
      <div class="form-group">
        <label>Bolsas Obtenidas</label>
        <input
          type="number"
          [(ngModel)]="nuevoLote.bolsasResultantes"
          (ngModelChange)="calcularCostos()"
          placeholder="0"
          min="1"
          class="text-center bold-input"
        />
        <span class="hint">Total empaquetado</span>
      </div>
    </div>

    <!-- Notas -->
    <div class="form-group">
      <label>Notas (opcional)</label>
      <input
        type="text"
        [(ngModel)]="nuevoLote.notas"
        placeholder="Ej: Proveedor nuevo, sali√≥ muy picante..."
      />
    </div>

    <!-- Previsualizaci√≥n de C√°lculos -->
    @if (costoUnitarioCalculado > 0) {
    <div class="calculos-preview">
      <div class="calculo-principal">
        <span class="calculo-label">COSTO REAL POR BOLSA</span>
        <span class="calculo-valor">{{
          formatearMoneda(costoUnitarioCalculado)
        }}</span>
      </div>
      <div class="calculos-secundarios">
        <div class="calculo">
          <span class="label">Utilidad Est.</span>
          <span class="valor" [class.negativo]="utilidadPorBolsa < 0">
            {{ formatearMoneda(utilidadPorBolsa) }}
          </span>
        </div>
        <div class="calculo">
          <span class="label">Margen</span>
          <span class="valor" [class.negativo]="margenPorcentaje < 0">
            {{ margenPorcentaje }}%
          </span>
        </div>
      </div>
    </div>
    }

    <!-- Botones -->
    <div class="modal-actions">
      <button
        class="btn-guardar"
        (click)="guardarLote()"
        [disabled]="
          !nuevoLote.saborId ||
          !nuevoLote.costoKilo ||
          !nuevoLote.bolsasResultantes ||
          guardando
        "
      >
        @if (guardando) { Guardando... } @else { ‚úì Confirmar Producci√≥n }
      </button>

      <button class="btn-cancelar" (click)="cerrarModal()">Cancelar</button>
    </div>
  </div>
</div>
}
