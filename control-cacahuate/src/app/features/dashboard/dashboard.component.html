<div class="dashboard-container">
  <header class="header">
    <div class="brand">
      <h1>ğŸ“Š Dashboard</h1>
      <p class="subtitle">{{ nombreNegocio }}</p>
    </div>
    <!-- Fecha de hoy -->
    <div class="fecha-badge">
      {{ fechaHoy | date : "EEEE d MMMM" }}
    </div>
  </header>

  @if (resumen$ | async; as resumen) {

  <!-- SECCIÃ“N 1: SALUD FINANCIERA DEL DÃA -->
  <section class="overview-section">
    <div class="main-stats-grid">
      <!-- Tarjeta Principal: Utilidad Real -->
      <div class="stat-card featured utilidad">
        <div class="icon-bg">ğŸ“ˆ</div>
        <div class="stat-content">
          <span class="label">Utilidad Real (Hoy)</span>
          <span class="valor" [class.negativo]="resumen.utilidadBrutaHoy < 0">
            {{ formatearMoneda(resumen.utilidadBrutaHoy) }}
          </span>
          <div class="mini-chart-container">
            <div class="margen-pill" [class.good]="resumen.margenHoy >= 30">
              Margen: {{ resumen.margenHoy | number : "1.0-1" }}%
            </div>
          </div>
        </div>
      </div>

      <!-- Tarjeta Secundaria: Caja (Liquidez) -->
      <div class="stat-card efectivo">
        <div class="stat-content">
          <span class="label">Dinero en Caja</span>
          <span class="valor">{{ formatearMoneda(resumen.efectivoHoy) }}</span>
          <span class="detalle">Ventas + Abonos</span>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCIÃ“N 2: DESGLOSE VISUAL -->
  <div class="split-grid">
    <!-- Columna Izquierda: Desglose de Ventas -->
    <section class="seccion sales-breakdown">
      <h3>ğŸ“‹ Movimientos del DÃ­a</h3>

      <!-- Barra de Progreso Visual de Ventas -->
      <div class="sales-bar-container">
        @if (resumen.ventasTotalesHoy > 0) {
        <div class="sales-bar">
          <div
            class="segment cash"
            [style.flex-grow]="resumen.ventasEfectivoHoy"
          ></div>
          <div
            class="segment credit"
            [style.flex-grow]="resumen.ventasFiadoHoy"
          ></div>
        </div>
        <div class="sales-legend">
          <span class="legend-item"
            ><span class="dot cash"></span>Efectivo ({{
              resumen.ventasEfectivoHoy / resumen.ventasTotalesHoy | percent
            }})</span
          >
          <span class="legend-item"
            ><span class="dot credit"></span>Fiado ({{
              resumen.ventasFiadoHoy / resumen.ventasTotalesHoy | percent
            }})</span
          >
        </div>
        } @else {
        <p class="no-data">Sin ventas registradas hoy</p>
        }
      </div>

      <div class="desglose-list">
        <div class="row">
          <span>Ventas Efectivo</span>
          <span class="num text-success"
            >+{{ formatearMoneda(resumen.ventasEfectivoHoy) }}</span
          >
        </div>
        <div class="row">
          <span>Ventas Fiado</span>
          <span class="num text-warning"
            >+{{ formatearMoneda(resumen.ventasFiadoHoy) }}</span
          >
        </div>
        <div class="row">
          <span>Abonos Recibidos</span>
          <span class="num text-success"
            >+{{ formatearMoneda(resumen.abonosHoy) }}</span
          >
        </div>
        <div class="divider"></div>
        <div class="row cost">
          <span>Costo de Venta (Insumos)</span>
          <span class="num text-danger"
            >-{{ formatearMoneda(resumen.costoVendidoHoy) }}</span
          >
        </div>
      </div>
    </section>

    <!-- Columna Derecha: DistribuciÃ³n de Capital -->
    <section class="seccion capital-distribution">
      <h3>ğŸ’° Â¿DÃ³nde estÃ¡ tu dinero?</h3>

      <div class="capital-chart-wrapper">
        <!-- GrÃ¡fico de Dona SVG Puro -->
        <svg viewBox="0 0 36 36" class="donut-chart">
          <!-- Fondo -->
          <path
            class="circle-bg"
            d="M18 2.0845
              a 15.9155 15.9155 0 0 1 0 31.831
              a 15.9155 15.9155 0 0 1 0 -31.831"
          />
          <!-- Segmento Inventario -->
          <path
            class="circle-segment inventory"
            [attr.stroke-dasharray]="
              getCircleDashArray(
                (resumen.valorInventario / resumen.capitalTotal) * 100
              )
            "
            d="M18 2.0845
              a 15.9155 15.9155 0 0 1 0 31.831
              a 15.9155 15.9155 0 0 1 0 -31.831"
          />
        </svg>
        <div class="chart-center-text">
          <span class="label">Capital Total</span>
          <span class="value">{{ formatearMoneda(resumen.capitalTotal) }}</span>
        </div>
      </div>

      <div class="chart-legend">
        <div class="legend-item">
          <div class="icon-box inventory">ğŸ“¦</div>
          <div class="info">
            <span class="type">Inventario</span>
            <span class="amount">{{
              formatearMoneda(resumen.valorInventario)
            }}</span>
          </div>
        </div>
        <div class="legend-item">
          <div class="icon-box debt">ğŸƒ</div>
          <div class="info">
            <span class="type">En la Calle (Deuda)</span>
            <span class="amount">{{
              formatearMoneda(resumen.dineroEnCalle)
            }}</span>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- SECCIÃ“N 3: RENDIMIENTO DE PRODUCCIÃ“N -->
  <section class="seccion production-stats">
    <div class="header-row">
      <h3>âš¡ Eficiencia de Cocina</h3>
      <span class="badge-avg"
        >{{ resumen.rendimientoPromedio }} bolsas/lote</span
      >
    </div>

    @if (lotes$ | async; as lotes) { @if (lotes.length > 0) {
    <div class="stats-pills">
      <div class="stat-pill best">
        <span class="label">Mejor</span>
        <span class="val">{{ getBestRendimiento(lotes) }}</span>
      </div>
      <div class="stat-pill worst">
        <span class="label">Peor</span>
        <span class="val">{{ getWorstRendimiento(lotes) }}</span>
      </div>
      <div class="stat-pill count">
        <span class="label">Total Lotes</span>
        <span class="val">{{ lotes.length }}</span>
      </div>
    </div>
    } @else {
    <p class="empty-msg">Registra tu primer lote para ver estadÃ­sticas</p>
    } }
  </section>

  <!-- ACCIÃ“N RÃPIDA -->
  <div class="actions-area">
    <button class="btn-corte" routerLink="/corte-caja" disabled>
      <span class="icon">âœ‚ï¸</span> Realizar Corte de Caja (PrÃ³ximamente)
    </button>
  </div>

  } @else {
  <!-- SKELETON LOADING -->
  <div class="loading-grid">
    <app-skeleton height="120px" borderRadius="16px"></app-skeleton>
    <app-skeleton height="200px" borderRadius="16px"></app-skeleton>
    <app-skeleton height="200px" borderRadius="16px"></app-skeleton>
  </div>
  }
</div>
