<div class="corte-container">
  <header class="header">
    <div class="brand">
      <span class="icon">‚úÇÔ∏è</span>
      <h1>Corte de Caja</h1>
    </div>
    <p class="subtitle">{{ fechaHoy | date : "EEEE d MMMM, y" }}</p>
  </header>

  @if (cargando) {
  <div class="loading-state">
    <div class="spinner"></div>
    <p>Consultando ventas del d√≠a...</p>
  </div>
  } @else { @if (corteYaRealizado) {
  <div class="mensaje-ya-realizado">
    <div class="check-icon">‚úÖ</div>
    <h3>D√≠a Cerrado</h3>
    <p>El corte de este d√≠a ya fue registrado.</p>
    <button class="btn-back" routerLink="/dashboard">Volver al Inicio</button>
  </div>
  }

  <div class="corte-card" [class.bloqueado]="corteYaRealizado">
    <!-- SECCI√ìN 1: SISTEMA -->
    <section class="info-sistema">
      <div class="row-total">
        <span class="label">Sistema Espera</span>
        <span class="valor sistema">{{
          formatearMoneda(cajaHoy?.totalEfectivo || 0)
        }}</span>
      </div>
      <div class="desglose-mini">
        <span
          >Ventas Ef.: {{ formatearMoneda(cajaHoy?.efectivoVentas || 0) }}</span
        >
        <span>Abonos: {{ formatearMoneda(cajaHoy?.efectivoAbonos || 0) }}</span>
      </div>
    </section>

    <div class="separador"></div>

    <!-- SECCI√ìN 2: CONTEO F√çSICO -->
    <section class="input-section">
      <label>1. ¬øCu√°nto dinero contaste?</label>
      <div class="input-group">
        <span class="symbol">$</span>
        <input
          type="number"
          [(ngModel)]="efectivoContado"
          (ngModelChange)="calcularDiferencia()"
          placeholder="0.00"
          [disabled]="corteYaRealizado"
        />
        <button
          class="btn-action-mini"
          (click)="igualarAlSistema()"
          [disabled]="corteYaRealizado"
        >
          Igualar
        </button>
      </div>

      @if (diferencia !== 0 && efectivoContado !== null) {
      <div
        class="alerta-diff"
        [class.sobra]="diferencia > 0"
        [class.falta]="diferencia < 0"
      >
        @if (diferencia > 0) { ‚ö†Ô∏è Sobran {{ formatearMoneda(diferencia) }} }
        @else { üö® Faltan {{ formatearMoneda(diferencia) }}
        }
      </div>
      }
    </section>

    <!-- SECCI√ìN 3: RETIRO CON SUGERENCIAS -->
    <section class="input-section">
      <label>2. ¬øCu√°nto vas a retirar?</label>

      <!-- SUGERENCIAS INTELIGENTES -->
      @if (efectivoContado && efectivoContado > 0 && !corteYaRealizado) {
      <div class="sugerencias-chips">
        <span class="label-mini">Dejar en caja:</span>

        <button
          class="chip"
          (click)="dejarFondo(0)"
          [class.active]="fondoFinal === 0"
        >
          Nada (Retirar todo)
        </button>

        @if (efectivoContado >= 200) {
        <button
          class="chip"
          (click)="dejarFondo(200)"
          [class.active]="fondoFinal === 200"
        >
          $200
        </button>
        } @if (efectivoContado >= 500) {
        <button
          class="chip"
          (click)="dejarFondo(500)"
          [class.active]="fondoFinal === 500"
        >
          $500
        </button>
        }
      </div>
      }

      <div class="input-group">
        <span class="symbol">$</span>
        <input
          type="number"
          [(ngModel)]="montoRetiro"
          (ngModelChange)="calcularFondo()"
          placeholder="0.00"
          [disabled]="corteYaRealizado"
        />
      </div>
      <p class="hint">Ganancia o dep√≥sito a banco</p>
    </section>

    <!-- SECCI√ìN 4: FONDO FINAL -->
    <section class="resumen-final">
      <div class="fila">
        <span>Se queda en caja (Fondo):</span>
        <span class="valor final">{{ formatearMoneda(fondoFinal) }}</span>
      </div>
    </section>

    <!-- NOTAS -->
    <div class="form-group">
      <label>Notas</label>
      <textarea
        [(ngModel)]="notas"
        rows="2"
        placeholder="Ej: Dej√© cambio en monedas..."
        [disabled]="corteYaRealizado"
      ></textarea>
    </div>

    <!-- BOT√ìN -->
    @if (!corteYaRealizado) {
    <button
      class="btn-cerrar"
      (click)="confirmarCorte()"
      [disabled]="guardando || efectivoContado === null"
    >
      @if (guardando) { ‚è≥ Cerrando... } @else { üîí Cerrar D√≠a }
    </button>
    }
  </div>
  }
</div>
