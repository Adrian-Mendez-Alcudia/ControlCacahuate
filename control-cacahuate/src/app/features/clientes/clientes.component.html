<div class="clientes-container">
  <header class="header">
    <h1>ğŸ‘¥ Cuentas por Cobrar</h1>
    <p class="subtitle">Gestiona los fiados pendientes</p>
  </header>

  <!-- Mensaje -->
  @if (mensaje) {
  <!-- AquÃ­ agregamos la clase dinÃ¡mica [class.error] -->
  <div class="mensaje" [class.error]="mensajeError">{{ mensaje }}</div>
  }

  <!-- Total en la calle -->
  @if (dineroEnCalle$ | async; as total) {
  <div class="total-calle">
    <span class="label">ğŸ’° DINERO EN LA CALLE</span>
    <span class="monto">{{ formatearMoneda(total) }}</span>
  </div>
  }

  <!-- BotÃ³n nuevo cliente -->
  <button class="btn-nuevo-cliente" (click)="abrirModalNuevoCliente()">
    â• Nuevo Cliente
  </button>

  <!-- Lista de deudores -->
  <section class="seccion">
    <h2>ğŸ“‹ Clientes con Deuda</h2>

    @if (deudores$ | async; as deudores) { @if (deudores.length === 0) {
    <div class="empty-state">
      <span class="emoji">ğŸ‰</span>
      <p>Â¡No hay deudas pendientes!</p>
    </div>
    } @else {
    <div class="deudores-lista">
      @for (cliente of deudores; track cliente.id) {
      <div class="deudor-item" [class.vencido]="cliente.estaVencido">
        <div class="deudor-info">
          <div class="deudor-header">
            <span
              class="indicador"
              [class.vencido]="cliente.estaVencido"
            ></span>
            <span class="nombre">{{ cliente.alias }}</span>
          </div>
          @if (cliente.fechaPromesaPago) {
          <span class="fecha-promesa" [class.vencido]="cliente.estaVencido">
            @if (cliente.estaVencido) { âš ï¸ Vencido:
            {{ cliente.fechaPromesaPago.toDate() | date : "dd/MM/yy" }} } @else
            { ğŸ“… Promesa:
            {{ cliente.fechaPromesaPago.toDate() | date : "dd/MM/yy" }}
            }
          </span>
          }
        </div>
        <div class="deudor-monto">
          <span class="monto" [class.vencido]="cliente.estaVencido">
            {{ formatearMoneda(cliente.saldoPendiente) }}
          </span>
          <button class="btn-abonar" (click)="abrirModalAbono(cliente)">
            ğŸ’µ Abonar
          </button>
        </div>
      </div>
      }
    </div>
    } } @else {
    <div class="loading">Cargando...</div>
    }
  </section>

  <!-- Todos los clientes -->
  <section class="seccion">
    <h2>ğŸ‘¤ Todos los Clientes</h2>

    @if (todosClientes$ | async; as clientes) { @if (clientes.length === 0) {
    <div class="empty-state">
      <p>No hay clientes registrados</p>
    </div>
    } @else {
    <div class="clientes-lista">
      @for (cliente of clientes; track cliente.id) {
      <div class="cliente-item">
        <span class="nombre">{{ cliente.alias }}</span>
        <span class="saldo" [class.tiene-deuda]="cliente.saldoPendiente > 0">
          {{ formatearMoneda(cliente.saldoPendiente) }}
        </span>
      </div>
      }
    </div>
    } }
  </section>
</div>

<!-- Modal Abono -->
@if (modalAbonoVisible && clienteSeleccionado) {
<div class="modal-overlay" (click)="cerrarModalAbono()">
  <div class="modal" (click)="$event.stopPropagation()">
    <h2>ğŸ’µ Registrar Abono</h2>

    <div class="cliente-info-modal">
      <span class="nombre">{{ clienteSeleccionado.alias }}</span>
      <span class="deuda"
        >Deuda: {{ formatearMoneda(clienteSeleccionado.saldoPendiente) }}</span
      >
    </div>

    <div class="form-group">
      <label>Monto del abono</label>
      <div class="input-prefix">
        <span class="prefix">$</span>
        <input
          type="number"
          [(ngModel)]="montoAbono"
          [max]="clienteSeleccionado.saldoPendiente"
          placeholder="0"
          min="1"
        />
      </div>
    </div>

    <!-- Botones rÃ¡pidos -->
    <div class="montos-rapidos">
      <button (click)="setMontoRapido(10)">$10</button>
      <button (click)="setMontoRapido(20)">$20</button>
      <button (click)="setMontoRapido(50)">$50</button>
      <button (click)="pagarTodo()" class="pagar-todo">Todo</button>
    </div>

    <div class="form-group">
      <label>Notas (opcional)</label>
      <input
        type="text"
        [(ngModel)]="notasAbono"
        placeholder="Ej: Abono parcial"
      />
    </div>

    <button
      class="btn-confirmar"
      (click)="confirmarAbono()"
      [disabled]="!montoAbono || montoAbono <= 0 || guardando"
    >
      âœ“ Confirmar Abono
    </button>

    <button class="btn-cancelar" (click)="cerrarModalAbono()">Cancelar</button>
  </div>
</div>
}

<!-- Modal Nuevo Cliente -->
@if (modalNuevoClienteVisible) {
<div class="modal-overlay" (click)="cerrarModalNuevoCliente()">
  <div class="modal" (click)="$event.stopPropagation()">
    <h2>ğŸ‘¤ Nuevo Cliente</h2>

    <div class="form-group">
      <label>Nombre o alias *</label>
      <input
        type="text"
        [(ngModel)]="nuevoCliente.alias"
        placeholder="Ej: Juan MecÃ¡nico"
      />
    </div>

    <div class="form-group">
      <label>TelÃ©fono (opcional)</label>
      <input
        type="tel"
        [(ngModel)]="nuevoCliente.telefono"
        placeholder="Ej: 555-123-4567"
      />
    </div>

    <div class="form-group">
      <label>Notas (opcional)</label>
      <input
        type="text"
        [(ngModel)]="nuevoCliente.notas"
        placeholder="Ej: Cliente frecuente"
      />
    </div>

    <button
      class="btn-confirmar"
      (click)="crearCliente()"
      [disabled]="!nuevoCliente.alias.trim() || guardando"
    >
      âœ“ Crear Cliente
    </button>

    <button class="btn-cancelar" (click)="cerrarModalNuevoCliente()">
      Cancelar
    </button>
  </div>
</div>
}
